<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Learn Vue</title>
  </head>

  <body>
    <div id="app">
      {{name}}
    </div>
    <script>
      class Vue {
        constructor({ el, data }) {
          this.$el = document.querySelector(el)
          this.data = data

          this.init()
        }

        init() {
          if (this.$el) {
            // 获取 dom
            this.$fragment = this.node2Fragment(this.$el)

            // 编译 dom
            this.compileElement(this.$fragment)

            // 回填 dom
            this.$el.appendChild(this.$fragment)
          }
        }

        node2Fragment(el) {
          // 新建文档碎片
          let fragment = document.createDocumentFragment()
          let child

          // 将原生结点拷贝至 fragment 中
          while (child = el.firstChild) {
            fragment.appendChild(child)
          }

          return fragment
        }

        compileElement(el) {
          let { childNodes } = el

          Array.from(childNodes).forEach(node => {
            let text = node.textContent
            let reg = /\{\{(.*)\}\}/

            if (this.isElementNode(node)) {
              this.compile(node)
            } else if (this.isTextNode(node) && reg.test(text)) {
              this.compileText(node, RegExp.$1)
            }

            // 递归遍历子节点
            if (node.childNodes && node.childNodes.length) {
              this.compileElement(node)
            }
          })
        }

        isElementNode() {}

        isTextNode() {}

        isDirective() {}

        isEventDirective() {}

        compile(node) {
          let { attributes } = node

          if (!attributes) {
            return
          }

          Array.from(attributes).forEach(attr => {
            // 指令以 v-xxx 命名
            // 比如 <span v-text="content"></span>
            let attrName = attr.name // v-text
            let exp = attr.value // content

            if (this.isDirective(attrName)) {
              // 普通指令
              let dir = attrName.split('v-')[1]
              this[dir] && this[dir](node, this.$vm, exp)
            }

            if (this.isEventDirective(attrName)) {
              // 事件指令
              let dir = attrName.split('@')[1]
              this.eventHandler(node, this.$vm, exp, dir)
            }
          })
        }

        compileText(node, exp) {
          this.text(node, this.$vm, exp)
        }

        eventHandler() {}
      }
    </script>
  </body>
</html>
