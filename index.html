<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Learn Vue</title>
  </head>

  <body>
    <div id="app">
      {{name}}
      <button @click="changeName">Change</button>
    </div>
    <script>
      class Vue {
        constructor({ el, data, methods }) {
          this.$el = document.querySelector(el)
          this.data = data

          Object.keys(this.data).forEach(key => {
            // 实现 this.xxx 指向 this.data.xxx
            this.proxyData(key)

            // 将 this.data 相应式化
            this.defineReactive(this.data, key, this.data[key])
          })

          // 实现 this.xxx 指向 this.methods.xxx
          for (const method in methods) {
            if (methods.hasOwnProperty(method)) {
              this[method] = methods[method]
            }
          }

          this.init()
        }

        proxyData(key) {
          Object.defineProperty(this, key, {
            configurable: false,
            enumerable: true,
            get() {
              return this.data[key]
            },
            set(val) {
              this.data[key] = val
            }
          })
        }

        defineReactive(obj, key, val) {
          const dep = new Dep()

          Object.defineProperty(obj, key, {
            configurable: true,
            enumerable: true,
            get() {
              console.log('observer.get')
              console.log(Dep.target)
              if (Dep.target) {
                dep.depend()
              }

              return val
            },
            set(newVal) {
              console.log('observer.set: %s', newVal)
              if (newVal === val) {
                return
              }

              val = newVal
              dep.notify()
            }
          })
        }

        init() {
          if (this.$el) {
            // 获取 dom
            this.$fragment = this.node2Fragment(this.$el)

            // 编译 dom
            this.compileElement(this.$fragment)

            // 回填 dom
            this.$el.appendChild(this.$fragment)
          }
        }

        node2Fragment(el) {
          // 新建文档碎片
          let fragment = document.createDocumentFragment()
          let child

          // 将原生结点拷贝至 fragment 中
          while (child = el.firstChild) {
            fragment.appendChild(child)
          }

          return fragment
        }

        compileElement(el) {
          let { childNodes } = el

          Array.from(childNodes).forEach(node => {
            let text = node.textContent
            let reg = /\{\{(.*)\}\}/

            if (this.isElementNode(node)) {
              this.compile(node)
            } else if (this.isTextNode(node) && reg.test(text)) {
              this.compileText(node, RegExp.$1)
            }

            // 递归遍历子节点
            if (node.childNodes && node.childNodes.length) {
              this.compileElement(node)
            }
          })
        }

        isElementNode(node) {
          return node.nodeType === 1
        }

        isTextNode(node) {
          return node.nodeType === 3
        }

        compileText(node, exp) {
          this.text(node, this, exp)
        }

        compile(node) {
          let { attributes } = node

          if (!attributes) {
            return
          }

          Array.from(attributes).forEach(attr => {
            // 指令以 v-xxx 命名
            // 比如 <span v-text="content"></span>
            let attrName = attr.name // v-text
            let exp = attr.value // content

            if (this.isDirective(attrName)) {
              // 普通指令
              let dir = attrName.split('v-')[1]
              this[dir] && this[dir](node, this, exp, dir)
            }

            if (this.isEventDirective(attrName)) {
              // 事件指令
              let dir = attrName.split('@')[1]
              this.eventHandler(node, this, exp, dir)
            }
          })
        }

        isDirective(attrName) {
          return /^v-(model|text)$/.test(attrName)
        }

        isEventDirective(attrName) {
          return attrName.indexOf('@') === 0
        }

        eventHandler(node, vm, exp, dir) {
          const eventType = dir
          const fn = vm[exp] || function() {}

          if (eventType) {
            node.addEventListener(eventType, fn.bind(vm), false)
          }
        }

        text(node, vm, exp) {
          const value = this[exp]
          dirText(node, value)

          this.addWatcher(vm, exp, (newVal, oldVal) => {
            dirText(node, newVal)
          })
        }

        addWatcher(vm, exp, cb) {
          new Watcher(vm, exp, cb)
        }
      }

      const dirText = (node, value) => {
        node.textContent = value || ''
      }

      let uid = 0

      class Dep {
        static target = null

        constructor() {
          this.id = uid++
          this.subs = []
        }

        addSub(sub) {
          this.subs.push(sub)
        }

        depend() {
          Dep.target.addDep(this)
        }

        notify() {
          for (const sub of this.subs) {
            sub.update()
          }
        }
      }

      class Watcher {
        constructor(vm, exp, cb) {
          this.vm = vm
          this.exp = exp
          this.cb = cb
          this.depIds = new Set()
        }

        addDep(dep) {
          if (!this.depIds.has(dep.id)) {
            this.depIds.add(dep.id)
            dep.addSub(this)
          }
        }
      }

      new Vue({
        el: '#app',
        data: {
          name: 'Roshan'
        },
        methods: {
          changeName() {
            this.name = 'Vue user'
          }
        }
      })
    </script>
  </body>
</html>
